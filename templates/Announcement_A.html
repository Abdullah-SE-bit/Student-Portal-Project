{% extends "admin_dashboard.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='announcements_admin.css') }}">
{% endblock %}

{% block content %}
<div class="announcements-page admin-ann-page">

  <div class="ann-toolbar">
    <form class="ann-filters" method="get" action="{{ url_for('admin_announcements') }}">
      <select name="audience">
        <option value="students" {{ 'selected' if current_audience=='students' }}>Students</option>
        <option value="teachers" {{ 'selected' if current_audience=='teachers' }}>Teachers</option>
        <option value="all"      {{ 'selected' if current_audience=='all' }}>All</option>
      </select>

      <select name="batch">
        <option value="">All batches</option>
        {% for b in batches %}
        <option value="{{ b }}" {{ 'selected' if current_batch==b }}>{{ b }}</option>
        {% endfor %}
      </select>

      <select name="department">
        <option value="">All departments</option>
        {% for d in departments %}
        <option value="{{ d }}" {{ 'selected' if current_department==d }}>{{ d }}</option>
        {% endfor %}
      </select>

      <select name="section">
        <option value="">All sections</option>
        {% for s in sections %}
        <option value="{{ s }}" {{ 'selected' if current_section==s }}>{{ s }}</option>
        {% endfor %}
      </select>

      <button type="submit" class="btn-primary-small">Filter</button>
    </form>
  </div>

  <div class="ann-layout">
    <section class="ann-form-panel">
      <h2 class="ann-section-title">New announcement</h2>
      <form method="post" action="{{ url_for('admin_announcements_create') }}" enctype="multipart/form-data" class="ann-form">
        <input type="hidden" name="audience" value="{{ current_audience or 'students' }}">

        <label>Title
          <input type="text" name="title" required>
        </label>

        <label>Message
          <textarea name="body" rows="4" required></textarea>
        </label>

        <label>Batch (optional)
          <select name="batch">
            <option value="">All batches</option>
            {% for b in batches %}
            <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
          </select>
        </label>

        <label>Department (optional)
          <select name="department">
            <option value="">All departments</option>
            {% for d in departments %}
            <option value="{{ d }}">{{ d }}</option>
            {% endfor %}
          </select>
        </label>

        <label>Section (optional)
          <select name="section">
            <option value="">All sections</option>
            {% for s in sections %}
            <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </label>

        <label>Attachments (optional)
          <input type="file" name="files" multiple>
        </label>

        <button type="submit" class="btn-primary-main">Post</button>
      </form>
    </section>

    <section class="ann-list-panel">
      <h2 class="ann-section-title">Recent announcements</h2>

      {% if announcements %}
        {% for a in announcements %}
        <article class="ann-card" data-ann-id="{{ a.id }}">
          <header class="ann-card-header">
            <h3 class="ann-title">{{ a.title }}</h3>
            <span class="ann-meta">
              {{ a.created_by_role|capitalize }} â€¢ {{ a.created_at }}
            </span>
          </header>

          <p class="ann-body">{{ a.body }}</p>

          {% if a.attachments %}
          <div class="ann-attachments">
            {% for f in a.attachments %}
            <a href="{{ f.url }}" target="_blank" class="ann-attachment-link">{{ f.name }}</a>
            {% endfor %}
          </div>
          {% endif %}

          <details class="ann-discussion" data-ann-id="{{ a.id }}">
            <summary>Discussion</summary>
            <div class="ann-comments" data-role="comments"></div>
            <form class="ann-comment-form">
              <input type="text" name="text" placeholder="Write a reply..." required>
              <button type="submit">Send</button>
            </form>
          </details>
        </article>
        {% endfor %}
      {% else %}
        <p class="ann-empty">No announcements yet.</p>
      {% endif %}
    </section>
  </div>
</div>

<script>
(() => {
  const page = document.querySelector('.admin-ann-page');
  if (!page) return;

  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[m]));
  }

  function loadComments(card) {
    const annId = card.dataset.annId;
    const container = card.querySelector('.ann-comments');
    fetch(`/announcements/${encodeURIComponent(annId)}/comments`)
      .then(r => r.ok ? r.json() : [])
      .then(list => {
        container.innerHTML = '';
        if (!list.length) {
          container.innerHTML = '<p class="ann-no-comments">No comments yet.</p>';
          return;
        }
        list.forEach(c => {
          const div = document.createElement('div');
          div.className = 'ann-comment';
          div.innerHTML = `<span class="who">${escapeHtml(c.author_role)}:</span>
                           <span class="text">${escapeHtml(c.text)}</span>`;
          container.appendChild(div);
        });
      }).catch(console.error);
  }

  page.querySelectorAll('.ann-discussion').forEach(det => {
    det.addEventListener('toggle', () => {
      if (det.open) {
        const card = det.closest('.ann-card');
        loadComments(card);
      }
    });
    const form = det.querySelector('.ann-comment-form');
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const card = det.closest('.ann-card');
      const annId = card.dataset.annId;
      const input = form.querySelector('input[name="text"]');
      const text = input.value.trim();
      if (!text) return;
      fetch(`/announcements/${encodeURIComponent(annId)}/comments`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({text})
      }).then(r => r.json()).then(res => {
        if (res.status === 'ok') {
          input.value = '';
          loadComments(card);
        }
      }).catch(console.error);
    });
  });
})();
</script>
{% endblock %}
